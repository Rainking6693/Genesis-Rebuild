# Progressive Rollout Configuration for Phase 4 Deployment
# SPICE + Pipelex Integration
# Generated: November 2, 2025

rollout_strategy: SAFE
duration_days: 7

# Rollout Stages
stages:
  - name: "Canary"
    percentage: 10
    duration_hours: 48
    start_date: "2025-11-03T09:00:00Z"
    end_date: "2025-11-05T09:00:00Z"
    description: "Initial deployment to 10% of traffic for validation"
    success_criteria:
      test_pass_rate: 0.98        # ≥98% tests passing
      error_rate_max: 0.001       # <0.1% error rate
      p95_latency_max_ms: 200     # <200ms P95 latency
      spice_task_rate_min: 1      # At least 1 SPICE task/minute
      pipelex_success_rate_min: 0.95  # ≥95% Pipelex workflow success
    validation_checkpoints:
      - "24h after deployment"
      - "48h after deployment (stage completion)"

  - name: "Gradual Expansion"
    percentage: 50
    duration_hours: 48
    start_date: "2025-11-05T09:00:00Z"
    end_date: "2025-11-07T09:00:00Z"
    description: "Expand to 50% of traffic for moderate load validation"
    success_criteria:
      test_pass_rate: 0.98
      error_rate_max: 0.001
      p95_latency_max_ms: 200
      spice_task_rate_min: 5      # Higher load expected
      pipelex_success_rate_min: 0.95
    validation_checkpoints:
      - "24h after expansion"
      - "48h after expansion (stage completion)"

  - name: "Majority Rollout"
    percentage: 80
    duration_hours: 48
    start_date: "2025-11-07T09:00:00Z"
    end_date: "2025-11-09T09:00:00Z"
    description: "Deploy to 80% of traffic for full load validation"
    success_criteria:
      test_pass_rate: 0.98
      error_rate_max: 0.001
      p95_latency_max_ms: 200
      spice_task_rate_min: 10     # Production load
      pipelex_success_rate_min: 0.95
    validation_checkpoints:
      - "24h after rollout"
      - "48h after rollout (stage completion)"

  - name: "Full Deployment"
    percentage: 100
    duration_hours: 48           # 48h monitoring period after 100%
    start_date: "2025-11-09T09:00:00Z"
    end_date: "2025-11-11T09:00:00Z"
    description: "Full deployment with extended monitoring"
    success_criteria:
      test_pass_rate: 0.98
      error_rate_max: 0.001
      p95_latency_max_ms: 200
      spice_task_rate_min: 10
      pipelex_success_rate_min: 0.95
    validation_checkpoints:
      - "24h after full deployment"
      - "48h after full deployment (final validation)"

# Feature Flags Configuration
feature_flags:
  # Core SPICE + Pipelex flags
  USE_SPICE: true                      # Enable SPICE self-play evolution
  USE_PIPELEX: true                    # Enable Pipelex workflow orchestration
  PIPELEX_FALLBACK_MODE: true          # Enable graceful fallback to Genesis HTDAG

  # Observability flags
  ENABLE_OTEL_TRACING: true            # OpenTelemetry distributed tracing
  ENABLE_OTEL_METRICS: true            # OpenTelemetry metrics collection
  OTEL_SENSITIVE_DATA: false           # Do NOT log sensitive data in production

  # Orchestration flags
  ENABLE_HTDAG_PLANNER: true           # Hierarchical task decomposition
  ENABLE_HALO_ROUTER: true             # Logic-based agent routing
  ENABLE_AOP_VALIDATOR: true           # Agent Orchestration Principles validation
  ENABLE_DAAO_OPTIMIZER: true          # Cost optimization (48% reduction)

  # Layer 2 flags (SE-Darwin)
  ENABLE_SE_DARWIN: true               # Self-improving agents
  ENABLE_SICA_REASONING: true          # Reasoning-heavy self-improvement
  ENABLE_TRAJECTORY_POOL: true         # Multi-trajectory evolution

  # Layer 3 flags (A2A)
  ENABLE_A2A_PROTOCOL: true            # Agent-to-Agent communication
  A2A_ENFORCE_HTTPS: true              # HTTPS only for A2A
  A2A_RATE_LIMITING: true              # Rate limiting enabled

# Monitoring Configuration
monitoring:
  prometheus_checkpoints: 55           # 55 checkpoints over 48 hours
  checkpoint_interval_minutes: 52      # ~52 minutes per checkpoint (48h / 55)

  grafana_dashboards:
    - name: "genesis_system_health"
      file: "monitoring/dashboards/genesis_system_health.json"
      description: "Overall Genesis system health metrics"

    - name: "spice_performance"
      file: "monitoring/dashboards/spice_performance.json"
      description: "SPICE task generation and evolution metrics"

    - name: "pipelex_workflows"
      file: "monitoring/dashboards/pipelex_workflows.json"
      description: "Pipelex workflow execution and fallback metrics"

    - name: "error_rates_latency"
      file: "monitoring/dashboards/error_rates_latency.json"
      description: "Error rates and latency percentiles"

  alert_channels:
    - type: "email"
      address: "team@genesis.com"
      severity: ["critical", "high"]

    - type: "slack"
      webhook_url: "${SLACK_WEBHOOK_URL}"
      channel: "#deployments"
      severity: ["critical", "high", "medium"]

    - type: "pagerduty"
      api_key: "${PAGERDUTY_API_KEY}"
      service_id: "${PAGERDUTY_SERVICE_ID}"
      severity: ["critical"]

  metrics_to_track:
    - name: "genesis_test_pass_rate"
      description: "Percentage of tests passing"
      threshold: 0.98
      alert_on: "below_threshold"

    - name: "genesis_error_rate"
      description: "Percentage of requests with errors"
      threshold: 0.001
      alert_on: "above_threshold"

    - name: "genesis_request_duration_seconds"
      description: "Request duration histogram"
      threshold: 0.2              # 200ms P95
      alert_on: "p95_above_threshold"

    - name: "spice_tasks_generated_total"
      description: "Total SPICE tasks generated (counter)"
      threshold: 1                # At least 1 task/minute
      alert_on: "rate_below_threshold"

    - name: "pipelex_workflows_total"
      description: "Total Pipelex workflows executed (counter)"
      alert_on: "rate_drop"       # Alert on sudden rate drop

    - name: "pipelex_workflows_success_total"
      description: "Total successful Pipelex workflows (counter)"
      threshold: 0.95             # 95% success rate
      alert_on: "success_rate_below_threshold"

    - name: "pipelex_fallback_triggered_total"
      description: "Total Pipelex fallback activations (counter)"
      alert_on: "rate_spike"      # Alert on sudden spike

# Auto-Rollback Configuration
auto_rollback:
  enabled: true

  # Rollback triggers (ANY condition triggers rollback)
  triggers:
    - condition: "test_pass_rate < 0.95"
      description: "Test pass rate drops below 95%"
      severity: "critical"

    - condition: "error_rate > 0.01"
      description: "Error rate exceeds 1%"
      severity: "critical"

    - condition: "p95_latency > 500"     # milliseconds
      description: "P95 latency exceeds 500ms"
      severity: "high"

    - condition: "consecutive_violations >= 3"
      description: "3 consecutive metric violations"
      severity: "high"

    - condition: "spice_error_rate > 0.05"
      description: "SPICE error rate exceeds 5%"
      severity: "high"

    - condition: "pipelex_fallback_rate > 0.5"
      description: "Pipelex fallback rate exceeds 50%"
      severity: "medium"

  # Rollback actions
  actions:
    - "Disable SPICE (USE_SPICE=false)"
    - "Disable Pipelex (USE_PIPELEX=false)"
    - "Enable fallback mode (PIPELEX_FALLBACK_MODE=true)"
    - "Restart affected services"
    - "Send critical alert to on-call team"
    - "Update status page"
    - "Create incident report"

  # Cooldown period after rollback
  cooldown_minutes: 60           # 1 hour before retry allowed

  # Rollback validation
  validation_duration_minutes: 60  # Monitor for 1 hour post-rollback
  validation_criteria:
    test_pass_rate_min: 0.98
    error_rate_max: 0.001
    p95_latency_max_ms: 200

# Deployment Scripts
scripts:
  deploy: "scripts/deploy.sh"
  monitor: "scripts/monitor_deployment.py"
  rollback: "scripts/rollback.sh"
  analyze: "scripts/analyze_metrics.py"

# Communication
communication:
  pre_deployment_notification:
    recipients: ["team@genesis.com"]
    template: "templates/pre_deployment_email.txt"
    send_hours_before: 24

  stage_completion_notification:
    recipients: ["team@genesis.com", "#deployments"]
    template: "templates/stage_completion_email.txt"

  rollback_notification:
    recipients: ["team@genesis.com", "#incidents", "on-call@genesis.com"]
    template: "templates/rollback_email.txt"
    urgency: "high"

# Known Issues (Non-Blocking)
known_issues:
  - issue_id: "SPICE-001"
    description: "4 SPICE E2E tests failing due to agent_name parameter signature mismatch"
    severity: "low"
    impact: "Test infrastructure only, not production code"
    workaround: "Integration tests validate production code path (100% passing)"
    fix_priority: "P2 (post-deployment)"

  - issue_id: "TEST-001"
    description: "4 test files have collection errors (GUI/Phase7 components)"
    severity: "low"
    impact: "Future feature tests only, zero production impact"
    workaround: "Tests excluded from deployment validation"
    fix_priority: "P3 (Phase 7 implementation)"

  - issue_id: "PIPELEX-001"
    description: "2 Pipelex tests skipped (optional runtime features)"
    severity: "minimal"
    impact: "Optional features only, fallback mode operational"
    workaround: "Pipelex fallback to Genesis HTDAG tested and working"
    fix_priority: "P3 (enhancement)"

# Metadata
metadata:
  version: "1.0.0"
  created_by: "Forge (Testing Agent)"
  created_at: "2025-11-02T17:15:00Z"
  last_updated: "2025-11-02T17:15:00Z"
  deployment_type: "SPICE + Pipelex Integration"
  target_environment: "production"
  estimated_duration_days: 7
  estimated_downtime_hours: 0   # Zero-downtime deployment
  production_readiness_score: 8.8
