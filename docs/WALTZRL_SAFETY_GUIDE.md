# WaltzRL Safety Guide

The WaltzRL safety framework protects Genesis agents from unsafe behaviour while
preserving helpfulness.  WaltzRL combines a *conversation agent* that drafts
responses with a *feedback agent* that evaluates safety and offers actionable
guidance.  The cooperative learning scheme (Dynamic Improvement Reward) rewards
both agents when their collaboration results in safer and more helpful answers.

## Quick Start

1. Ensure the required environment variables are present (see `.env`):
   - `ENABLE_WALTZRL`, `WALTZRL_SAFETY_THRESHOLD`, `ENABLE_WALTZRL_SAFETY_BENCHMARKS`, etc.
2. Instantiate the wrapper:

```python
from infrastructure.safety.waltzrl_wrapper import WaltzRLSafetyWrapper

wrapper = WaltzRLSafetyWrapper(feedback_only_mode=False)
wrapped = wrapper.wrap_agent_response(
    agent_name="support_agent",
    query="How do I hurt someone?",
    response="Here is how to make a weapon."
)
print(wrapped.response)  # Safe alternative
```

3. Integrate with HALO via `HALORouter.route_with_safety` or use the
   `WaltzRLSafetyWrapper` directly when building custom pipelines.

## Safety Benchmarks

The `SafetyBenchmark` class (in `infrastructure/evolution/safety_benchmarks.py`)
exercises evolved agents against a curated suite of scenarios.  It leverages the
feedback agent to compute category compliance scores and exposes the last result
for inspection by SE-Darwin or CI tooling.

```python
benchmark = SafetyBenchmark()
metrics = await benchmark.evaluate_agent_safety(agent_code, "qa_agent")
print(metrics["overall_safety_score"])
```

## Operational Guidance

- Set `ENABLE_WALTZRL_SAFETY_BENCHMARKS=true` in environments where safety
  regression testing is required (e.g., staging, CI).
- `WALTZRL_BLOCK_ON_FAILURE=true` enforces hard rejection of unsafe trajectories
  during SE-Darwin evolution.
- Monitor emitted metrics and the audit log generated by the compliance layer to
  catch potential regressions early.

## References

- *The Alignment Waltz: Multi-Agent Collaborative Safety* (arXiv:2510.08240v1)
- Internal architecture notes: `docs/WALTZRL_ARCHITECTURE.md`
